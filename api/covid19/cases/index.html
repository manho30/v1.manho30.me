<script>

const getDates = () => {
    var dates = []
    var today = new Date();
    var todayMonth = today.getMonth() + 1
    if (parseInt(todayMonth) < 10) {
        todayMonth = "0" + todayMonth;
    }
    var todayDate = today.getDate() - 1
    if (parseInt(todayDate) < 10) {
        todayDate = "0" + todayDate;
    }
    var date = today.getFullYear() + "-" + todayMonth + "-" + todayDate;
    return date
}

const fetchVaxCSV = async () => {
  const baseUrl = "https://raw.githubusercontent.com/MoH-Malaysia/covid19-public/main/vaccination";
  const req = await fetch(`${baseUrl}/vax_malaysia.csv`);
  return await req.text();
};

const parseVaxCSV = (csv, dates) => {
    if(!dates){
        dates = getDates()
    } 
    const res = csv.split(/\n/);
    return res
        .filter((res) => {
            const data = res.split(",");
            return dates.includes(data[0]);
        })
        .map((res) => {
            const data = res.split(",");
            return {
                date: data[0],
                new_dose_1: parseInt(data[1]),
                new_dose_2: parseInt(data[2]),
                new_child_dose_1: parseInt(data[7]),
                new_child_dose_2: parseInt(data[8]),
                new_adol_dose_1: parseInt(data[5]),
                new_adol_dose_2: parseInt(data[6]), 
                new_booster_dose: parseInt(data[3]),
                new_total_dose_given: parseInt(data[4]), 
                total_dose_1: parseInt(data[9]),
                total_dose_2: parseInt(data[10]),
                total_dose_given: parseInt(data[12]),
                total_child_dose_1: parseInt(data[15]),
                total_child_dose_2: parseInt(data[16]),
                total_adol_dose_1: parseInt(data[13]), 
                total_adol_dose_2: parseInt(data[14]), 
                total_booster_dose: parseInt(data[11]),
            };
        });
}

const getVaxData = async () => {
  const csv = await fetchVaxCSV();
  return await parseVaxCSV(csv);
};
alert(GetVaxData())
</script>
